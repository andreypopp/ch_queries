#!/bin/bash
rg '(def|make_window) "([^"]+)"' -o -I --replace '$2' | sort -u |
clickhouse local --input-format "TSV" --multiquery --query "
with
existing as (select c1 from table),
used as (
  select arrayJoin([
    'arraySlice',
    'rand',
    'toYear',
    'mapContainsKey',
    'replaceAll',
    'arrayElement',
    'toFloat64',
    'toUInt64',
    'IPv4StringToNumOrDefault',
    'domainWithoutWWW',
    'AhrefsRoundSerpsVolume',
    'arrayConcat',
    'toInt32',
    'bitShiftLeft',
    'floor',
    'rowNumberInAllBlocks',
    'in',
    'ifNull',
    'alphaTokens',
    'toStartOfWeek',
    'joinGet',
    'notEquals',
    'abs',
    'toIntervalMinute',
    'coalesce',
    'isFinite',
    'plus',
    'negate',
    'replaceRegexpAll',
    'lowerUTF8',
    'dictGet',
    'YYYYMMDDToDate',
    'mapValues',
    'subtractMinutes',
    'arrayFilter',
    'toDate',
    'if',
    'equals',
    'multiSearchFirstPositionCaseInsensitive',
    'toIntervalNanosecond',
    'toDateTime',
    'mapKeys',
    'toStartOfYear',
    'toIPv4',
    'arrayMap',
    'ignore',
    'toTypeName',
    'addWeeks',
    'toUInt8',
    'queryString',
    'bitAnd',
    'countSubstrings',
    'toIntervalDay',
    'arraySort',
    'match',
    'subtractDays',
    'minus',
    'arrayCount',
    'not',
    'empty',
    'toStartOfInterval',
    'hasAny',
    'subDate',
    'substringIndex',
    'addSeconds',
    'simpleJSONExtractString',
    'cutFragment',
    'bitNot',
    'positionUTF8',
    'tupleHammingDistance',
    'range',
    'greaterOrEquals',
    'ilike',
    'farmHash64',
    'round',
    'greatest',
    'farmFingerprint64',
    'map',
    'xxHash64',
    'subtractYears',
    'log',
    'arrayUniq',
    'timeSlots',
    'toStartOfHour',
    'startsWith',
    'notLike',
    'toBool',
    'toDecimal64',
    'arrayIntersect',
    'hostName',
    'JSONExtractString',
    'JSONExtractKeys',
    'toIntervalYear',
    'addHours',
    'toJSONString',
    'simpleJSONExtractInt',
    'ifNotFinite',
    'arrayDistinct',
    'array',
    'multiIf',
    'exp',
    'fromUnixTimestamp',
    'divide',
    'has',
    'multiSearchFirstPosition',
    'max2',
    'JSONExtract',
    'least',
    'arrayJoin',
    'toStartOfDay',
    'length',
    'replaceRegexpOne',
    'isNaN',
    'toUInt16',
    'nullIf',
    'joinGetOrNull',
    'extract',
    'toFloat32',
    'notIn',
    'CAST',
    'toMonth',
    'addMonths',
    'getMacro',
    'toInt128',
    'lessOrEquals',
    'positionCaseInsensitiveUTF8',
    'intExp2',
    'toStartOfSecond',
    'cutToFirstSignificantSubdomainCustom',
    'protocol',
    'addMinutes',
    'addDate',
    'trimBoth',
    'normalizeUTF8NFC',
    'endsWith',
    'substring',
    'dateDiff',
    'lower',
    'less',
    'splitByChar',
    'initializeAggregation',
    'decodeURLComponent',
    'unhex',
    'globalIn',
    'extractURLParameter',
    'and',
    'addDays',
    'toRelativeMonthNum',
    'multiply',
    'toYYYYMM',
    'decodeXMLComponent',
    'notEmpty',
    'toDateTime64',
    'toYearWeek',
    'arrayStringConcat',
    'intDiv',
    'arrayWithConstant',
    'toUInt32',
    'uptime',
    'arrayFlatten',
    'nullif',
    'subtractHours',
    'subtractSeconds',
    'addNanoseconds',
    'IPv4NumToStringClassC',
    'toInt16',
    'sipHash64',
    'toUnixTimestamp',
    'cast',
    'subtractMonths',
    'multiSearchAny',
    'IPv4NumToString',
    'toStartOfMinute',
    'splitByWhitespace',
    'toInt64',
    'moduloOrZero',
    'arrayExists',
    'arrayMax',
    'wordShingleMinHashCaseInsensitiveUTF8',
    'JSONExtractBool',
    'toNullable',
    'ifnull',
    'arrayReduce',
    'like',
    'isValidUTF8',
    'concat',
    'arrayPushFront',
    'arrayAll',
    'randCanonical',
    'arrayJaccardIndex',
    'indexOf',
    'finalizeAggregation',
    'greater',
    'notILike',
    'toString',
    'tupleElement',
    'modulo',
    'toIntervalMonth',
    'toYYYYMMDD',
    'arraySum',
    'position',
    'tuple',
    'toStringCutToZero',
    'toIntervalHour',
    'multiMatchAllIndices',
    'toIntervalWeek',
    'multiSearchAnyCaseInsensitiveUTF8',
    'now',
    'arrayReverseFill',
    'mapFromArrays',
    'or',
    'extractTextFromHTML',
    'toIntervalSecond',
    'today',
    'toStartOfMonth',
    'replicate',
    'inIgnoreSet',
    'parseDateTimeBestEffort',
    'substringUTF8',
    'cutQueryStringAndFragment',
    'arrayShingles',
    'JSONExtractInt',
    'assumeNotNull',
    'toValidUTF8',
    'extractAll',
    'lengthUTF8',
    'isNull',
    'JSONExtractUInt',
    'isNotNull',
    'arrayPushBack',
    'pow',
    'addYears',
    'domain',
    'multiMatchAny',
    'arrayFirstOrNull',
    'shardNum',
    'reverseUTF8',
    'arrayFirstIndex',
    'arrayEnumerate',
    'arrayZip',
    'accurateCastOrNull',
    'formatDateTime',
    'formatReadableSize',
    'appendTrailingCharIfAbsent',
    'multiSearchAnyUTF8',
    'trimRight',
    'defaultValueOfTypeName',
    'toUnixTimestamp64Milli',
    'formatReadableQuantity',
    'toUInt32OrDefault',
    'arrayCumSum',
    'arrayFirst',
    'identity',
    'age',
    'getSubcolumn',
    'subtractWeeks',
    'right',
    'toUInt64OrNull',
    'trunc',
    'cityHash64',
    'extractAllGroupsVertical',
    'firstNonDefault',
    'JSONHas',
    'toStartOfFifteenMinutes',
    'version'
  ]) as name
)
select name
from system.functions
where
  not is_aggregate and origin = 'System'
  and name in used
  and name not in ['CAST', 'and', 'or', 'not', 'map']
  and alias_to = ''
  and not startsWith(name, '__')
  and description != ''
  and name not in existing
  and name not in ['negate', 'divide', 'minus', 'plus', 'multiply', 'array', 'equals', 'notEquals', 'greater', 'greaterOrEquals', 'less', 'lessOrEquals']
order by categories, name limit 5
"
